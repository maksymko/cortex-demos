<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cortex-DemOS: demOS (demo-OS)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Cortex-DemOS<span id="projectnumber">&#160;0.1</span>
   </div>
   <div id="projectbrief">Cortex-M Microcontroller Operating System with focus on testability</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">demOS (demo-OS) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="mainpage"></a> This project is a microcontroller operating system that focuses heavily on testability.</p>
<p >Essentially, this is a research project, trying to figure out how far the concept can be taken, without using real hardware. The idea of being testable is what drives most of the design choices.</p>
<p >The OS is actually just a driver model, it uses <a href="https://freertos.org">FreeRTOS</a> for scheduling and IPC.</p>
<p >** This is not an officially supported Google product **</p>
<h1>Design for Test</h1>
<p >The project focuses on tests from the very beginning. This means that even very simple code, even the smallest driver must be tested and in true TDD tradition, it must be possible to write test first.</p>
<p >If you look at the firmware that is running on a typical ARM32 microcontroller, from the perspective of the firmware (software), the hardware is simply a set of registers, accessible through memory IO operations, plus interrupts.</p>
<p >Let's say you have a simple GPIO module. To set particular line high, you set the value of a corresponding bit in a 32 bit register.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> uint32_t gpio_reg_addr = 0x50000508;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> gpio_line = 8;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Setting the line high */</span></div>
<div class="line">*((<span class="keyword">volatile</span> uint32_t*)gpio_reg_addr) = (1 &lt;&lt; gpio_line);</div>
</div><!-- fragment --><p >Unfortunately, if we want to test this code off the hardware, i.e. on regular desktop computer, that memory write operation is kind of hard to mock.</p>
<p >The solution this project uses is very simple and is summed up in <a href="src/memio.h">memio.h</a>. All memory IO operations are defined as a function-like macros, for example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define raw_write32(addr, value)     *((volatile uint32_t*)(addr)) = (value)</span></div>
</div><!-- fragment --><p >When certain preprocessor option is given during compilation (<code>TEST_MEMIO</code>), this function-like macro becomes a real function:</p>
<div class="fragment"><div class="line">void raw_write32(uint32_t addr, uint32_t value);</div>
</div><!-- fragment --><p >For tests this function simply delegates to a method of a global object:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">mock::Memory g_memory;</div>
<div class="line"> </div>
<div class="line">extern &quot;C&quot; void raw_write32(uint32_t addr, uint32_t value) {</div>
<div class="line">    g_memory.write32(addr, value);</div>
<div class="line">}</div>
</div><!-- fragment --><p >This object is essentially a <code>std::map</code>, that maps from virtual, microcontroller's memory address to the value in that memory location.</p>
<p >It has more features, of course, but this is the basic idea. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
